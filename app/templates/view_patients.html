{% extends "base.html" %}

{% block title %}Patients - Stroke Prediction System{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Patient Records</h1>
        <a href="{{ url_for('patient.add_patient') }}" class="btn btn-primary">â• Add New Patient</a>
    </div>

    {% if patients %}
    <div class="table-responsive">
        <table class="table table-striped table-hover">
            <thead style="background: linear-gradient(135deg, #800000 0%, #A52A2A 100%); color: white;">
                <tr>
                    <th>ID</th>
                    <th>Gender</th>
                    <th>Age</th>
                    <th>Hypertension</th>
                    <th>Glucose Level</th>
                    <th>BMI</th>
                    <th>Smoking Status</th>
                    <th>Stroke</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for patient in patients %}
                <tr>
                    <td><small>{{ patient.get('id', 'N/A') }}</small></td>
                    <td>{{ patient.get('gender', 'N/A') }}</td>
                    <td>{{ patient.get('age', 'N/A') }}</td>
                    <td>
                        {% if patient.get('hypertension') == 1 or patient.get('hypertension') == '1' %}
                        <span class="badge bg-danger">Yes</span>
                        {% else %}
                        <span class="badge bg-success">No</span>
                        {% endif %}
                    </td>
                    <td>{{ patient.get('avg_glucose_level', 'N/A') }}</td>
                    <td>{{ patient.get('bmi', 'N/A') }}</td>
                    <td>{{ patient.get('smoking_status', 'N/A') }}</td>
                    <td>
                        {% if patient.get('stroke') == 1 or patient.get('stroke') == '1' %}
                        <span class="badge bg-danger">Yes</span>
                        {% else %}
                        <span class="badge bg-success">No</span>
                        {% endif %}
                    </td>
                    <td>
                        <button type="button" class="btn btn-sm btn-secondary" data-bs-toggle="modal" 
                                data-bs-target="#patientModal{{ loop.index }}" title="View Details">
                            ğŸ‘ï¸ View
                        </button>
                        <a href="{{ url_for('patient.edit_patient', patient_id=patient._id) }}" 
                           class="btn btn-sm btn-info">âœï¸ Edit</a>
                        <form method="POST" action="{{ url_for('patient.delete_patient', patient_id=patient._id) }}" 
                              style="display:inline;" onsubmit="return confirm('Are you sure?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="btn btn-sm btn-danger">ğŸ—‘ï¸ Delete</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Patient Detail Modals -->
    {% for patient in patients %}
    <div class="modal fade" id="patientModal{{ loop.index }}" tabindex="-1" aria-labelledby="patientModalLabel{{ loop.index }}" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #800000 0%, #A52A2A 100%); color: white;">
                    <h5 class="modal-title" id="patientModalLabel{{ loop.index }}">
                        Patient Details - ID: {{ patient._id }}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted">Personal Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>Patient ID:</th>
                                    <td><code>{{ patient._id }}</code></td>
                                </tr>
                                <tr>
                                    <th>Gender:</th>
                                    <td>{{ patient.get('gender', 'N/A') }}</td>
                                </tr>
                                <tr>
                                    <th>Age:</th>
                                    <td>{{ patient.get('age', 'N/A') }} years</td>
                                </tr>
                                <tr>
                                    <th>Email:</th>
                                    <td>{{ patient.get('email', 'N/A') }}</td>
                                </tr>
                                <tr>
                                    <th>Smoking Status:</th>
                                    <td>{{ patient.get('smoking_status', 'N/A') }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted">Medical Information</h6>
                            <table class="table table-sm">
                                <tr>
                                    <th>Hypertension:</th>
                                    <td>
                                        {% if patient.get('hypertension') == 1 or patient.get('hypertension') == '1' %}
                                            <span class="badge bg-danger">Yes</span>
                                        {% else %}
                                            <span class="badge bg-success">No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Heart Disease:</th>
                                    <td>
                                        {% if patient.get('heart_disease') == 1 or patient.get('heart_disease') == '1' %}
                                            <span class="badge bg-danger">Yes</span>
                                        {% else %}
                                            <span class="badge bg-success">No</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>Glucose Level:</th>
                                    <td>{{ patient.get('avg_glucose_level', 'N/A') }} mg/dL</td>
                                </tr>
                                <tr>
                                    <th>BMI:</th>
                                    <td>{{ patient.get('bmi', 'N/A') }}</td>
                                </tr>
                                <tr>
                                    <th>Stroke Risk:</th>
                                    <td>
                                        {% if patient.get('stroke') == 1 or patient.get('stroke') == '1' %}
                                            <span class="badge bg-danger">High Risk (Positive)</span>
                                        {% else %}
                                            <span class="badge bg-success">Low Risk (Negative)</span>
                                        {% endif %}
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    {% if patient.get('created_at') %}
                    <hr>
                    <small class="text-muted">
                        Created: {{ patient.get('created_at') }}
                    </small>
                    {% endif %}
                </div>
                <div class="modal-footer">
                    <a href="{{ url_for('patient.edit_patient', patient_id=patient._id) }}" class="btn btn-warning">
                        âœï¸ Edit Patient
                    </a>
                    <form method="POST" action="{{ url_for('patient.delete_patient', patient_id=patient._id) }}" 
                          style="display:inline;" onsubmit="return confirm('Are you sure?');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="btn btn-danger">ğŸ—‘ï¸ Delete Patient</button>
                    </form>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    <!-- Pagination with editable page number -->
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center align-items-center">
            {% if page > 1 %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('patient.view_patients', page=page-1) }}">Previous</a>
            </li>
            {% endif %}
            <li class="page-item active d-flex align-items-center" style="padding:0 8px;">
                <form id="pageJumpForm" method="get" action="{{ url_for('patient.view_patients') }}" class="d-flex align-items-center" style="gap:4px;">
                    <span class="page-link" style="padding:0 8px; background:transparent; border:none; color:#800000; font-weight:bold;">Page</span>
                    <input type="number" min="1" max="{{ total_pages }}" name="page" value="{{ page }}" style="width:60px; text-align:center;" class="form-control form-control-sm" required>
                    <span class="page-link" style="padding:0 8px; background:transparent; border:none; color:#800000; font-weight:bold;">of {{ total_pages }}</span>
                    <button type="submit" class="btn btn-sm btn-primary" style="margin-left:4px;">Go</button>
                </form>
            </li>
            {% if page < total_pages %}
            <li class="page-item">
                <a class="page-link" href="{{ url_for('patient.view_patients', page=page+1) }}">Next</a>
            </li>
            {% endif %}
        </ul>
    </nav>

    {% else %}
    <div class="alert alert-info" role="alert">
        No patients found. <a href="{{ url_for('patient.add_patient') }}">Add the first patient</a>
    </div>
    {% endif %}
</div>
{% endblock %}
